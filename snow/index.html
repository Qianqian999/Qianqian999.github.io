<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>雪，好美的雪 ε=ε=ε=(~￣▽￣)~</title>
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
      overflow: hidden;
      background-color: #000;
    }
  </style>
</head>

<body>
  <input type="range" min="10" max="200" id="range">
  <canvas id="canvas"></canvas>
  <script>
    const cos = Math.cos;
    const sin = Math.sin;
    const PI = Math.PI;
    const SIDE_NUM = 6;  // 雪花形状（正N边形）
    const THRESHOLD = 7;  // 显示第三层棱角的阈值
    let snowCount = 100;  // 雪花总数量
    let _WIDTH = window.innerWidth;  // 设备窗口宽度
    let _HEIGHT = window.innerHeight;  // 设备窗口高度
    let space = ~~(_HEIGHT / 4 * 16.6 / snowCount);  // 雪花出现时间间隔
    let snows = [];  // 存放雪花的数组
    let snow;  // 单个雪花
    let timeouts = []; // 雪花的定时器数组
    let canvas;
    let ctx;

    window.addEventListener('resize', () => {
      initCanvas();
      drawSnows();
    });
    window.onload = function () {
      initEvents();
      initCanvas();
      drawSnows();
      move();
    }

    const Snow = function () { };
    Snow.prototype = {
      init(x = random(0, _WIDTH), y = 0) {
        this.x = x;
        this.y = y;
        this.r = random(2, 12);
        this._x = random(0.2, 2);
        this._y = random(3, 5);
      },
      draw() {
        ctx.drawImage(this.snowCanvas, this.x, this.y)
        this.update();
      },
      update() {
        if (this.y < _HEIGHT - this.r) {
          this.y += this._y;
          if (this.x < _WIDTH - this.r) {
            this.x += this._x;
          } else {
            this.init(0, this.y);
          }
        } else {
          this.init();
        }
      }
    };

    function initEvents() {
      const range = document.getElementById('range');
      range.onchange = function () {
        timeouts.forEach(t => clearTimeout(t));
        snowCount = this.value;
        space = ~~(_HEIGHT / 4 * 16.6 / snowCount)
        drawSnows();
      }
    }

    function initCanvas() {
      _WIDTH = window.innerWidth;
      _HEIGHT = window.innerHeight;
      canvas = document.getElementById('canvas');
      canvas.setAttribute('width', _WIDTH);
      canvas.setAttribute('height', _HEIGHT);
      ctx = canvas.getContext('2d');
    }

    function drawSnows() {
      snows = snows.slice(0, snowCount);
      timeouts = [];
      for (let i = snows.length; i < snowCount; i += 1) {
        let timeout = setTimeout(function () {
          const snow = new Snow();
          snow.init();
          snow.snowCanvas = drawCanvas(snow.r);
          snows.push(snow);
        }, space * i);
        timeouts.push(timeout);
      }
    }

    function drawCanvas(size) {
      let coord = [[2 * size, 2 * size]];
      const canvasSnow = document.createElement('canvas');
      canvasSnow.setAttribute('width', coord[0][0] + size * 2);
      canvasSnow.setAttribute('height', coord[0][1] + size * 2);
      const ctxSnow = canvasSnow.getContext('2d');

      ctxSnow.save();
      ctxSnow.strokeStyle = '#FFFFFF';
      ctxSnow.lineWidth = 2;
      let coords = drawSnow(ctxSnow, coord, size);
      ctxSnow.lineWidth = 1;
      coords = drawSnow(ctxSnow, coords, size / 2.5);
      size > THRESHOLD && drawSnow(ctxSnow, coords, size / 6);
      ctxSnow.restore();
      return canvasSnow;
    }

    function drawSnow(ctxSnow, coord, size) {
      const coords = [];
      for (let i = 0, length = coord.length; i < length; i += 1) {
        for (let j = 0; j < SIDE_NUM; j += 1) {
          const { x2, y2 } = drawSide(ctxSnow, coord[i][0], coord[i][1], size, 2 * PI * (j / SIDE_NUM));
          coords.push([x2, y2]);
        }
      }
      return coords;
    }

    function drawSide(ctxSnow, x, y, size, radian) {
      const x2 = size * cos(radian) + x;
      const y2 = size * sin(radian) + y;
      drawLine(ctxSnow, x, y, x2, y2);
      return { x2, y2 };
    }

    function drawLine(ctxSnow, x1, y1, x2, y2) {
      ctxSnow.beginPath();
      ctxSnow.lineTo(x1, y1);
      ctxSnow.lineTo(x2, y2);
      ctxSnow.stroke();
    }

    function move() {
      ctx.clearRect(0, 0, _WIDTH, _HEIGHT);
      let length = snows.length;
      for (let i = 0; i < length; i++) {
        snows[i].draw();
      }
      requestAnimationFrame(move);
    }

    function random(min, max) {
      return Math.random() * (max - min) + min;
    }
  </script>
</body>

</html>